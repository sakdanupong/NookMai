<!DOCTYPE html>
{% autoescape true %}
<html>
    <head>
      <link rel="stylesheet" href="/bootstrap/css/bootstrap.css">
      <script src="//code.jquery.com/jquery-1.9.1.js"></script>
      <script src="/javascripts/NumberUtil.js"></script>
      <link rel="shortcut icon" href="images/favicon.ico"/>
      <link type="text/css" rel="stylesheet" href="/stylesheets/font_family.css" />
      <link type="text/css" rel="stylesheet" href="/stylesheets/base_document.css" />
      <link type="text/css" rel="stylesheet" href="/stylesheets/carousel.css" />
      <link type="text/css" rel="stylesheet" href="/stylesheets/main_body.css" />
      <script src="/javascripts/MoviewListView.js"></script>


      <!-- <link type="text/css" rel="stylesheet" href="/stylesheets/login_dialog.css" /> -->
      <!-- <link rel="stylesheet" href="/bootstrap/js/bootstrap.min.js"> -->
      <!-- <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no"> -->
      <title>nookmai.com หนุกมั้ยดอทคอม</title>
      <script>

        var gLoginDialog = null;

        var current_page_key = "current_page_key";
        var current_page = 1;
        var all_nowshowing_count = 0;
        var all_nowshowing_page = 0; 
        var btn_nowshowing_count = 0;

        var comingsoon_current_page_key = "comingsoon_current_page_key";
        var comingsoon_current_page = 1;
        var all_comingsoon_count = 0;
        var all_comingsoon_page = 0; 
        var btn_comingsoon_count = 0;

        var avatar_count = {{avatar_count}};

        function nowShowingFadeIn() {
          setTimeout(function() {
            $('#nowshowing_wraper').fadeIn();
            $('#nowshowing_wraper').show();
          }, 100);
        }

        function nowShowingFadeOut() {
          $('#nowshowing_wraper').hide();
          // setTimeout(function() {
          //   $('#nowshowing_wraper').fadeOut();
          // }, 500);
        }

        function comingSoonFadeIn() {
          setTimeout(function() {
            $('#comingsoon_wraper').fadeIn();
            $('#comingsoon_wraper').show();
          }, 100);
        }

        function comingSoonFadeOut() {
          $('#comingsoon_wraper').hide();
        }

        function randomMovie() {
          $.getJSON( "/trailer?movie_id={{random_movie['movie_id']}}", function(data) { 
            // src="//www.youtube.com/embed/2zqy21Z29ps?autoplay=0&loop=1
            var youtube_link = "//www.youtube.com/embed/"+data['videoId']+"?autoplay=1&html5=1";
            $("#feature_youtube_frame").get(0).contentWindow.location.replace(youtube_link);

            document.getElementById("feature_youtube_frame").onload = function() {
              setTimeout(function() {
                $('#feature_youtube_frame').fadeIn();
                $("#feature_youtube_frame").show();
              }, 100);
            };
          });
        }

        function sortDict(a,b) {
          if (a.name > b.name)
            return 1;
          if (a.name < b.name)
            return -1;
          // a must be equal to b
          return 0;
        }

        function getAvatarDict(data) {
          // var max_count = {};
          // for (var i = 1; i < avatar_count; i++) {
          //   var key = 'avatar_'+i+'_count';
          //   // list.push(['image_path': '/images/details/avatar/image_avatar' + i +'.png', data[key]);
          //   max_count['/images/details/avatar/image_avatar' + i +'.png'] = data[key];
          // }

          // var sortable = [];
          // for (var avatar in max_count) {
          //   sortable.push([avatar, max_count[avatar]])
          // }
      
          // sortable.sort(function(a, b) {return a[1] - b[1]})


          var status = [];
          for (var i = 1; i < avatar_count; i++) {
            var key_value = 'avatar_'+i+'_count';
            // list.push(['image_path': '/images/details/avatar/image_avatar' + i +'.png', data[key]);
            status.push({name: '/images/details/avatar/image_avatar' + i +'.png', value: data[key_value]});
          }
          // var status = [
          // { name: "Edward", value: 21 },
          // { name: "Sharpe", value: 37 },
          // { name: "And", value: 45 },
          // { name: "The", value: -12 },
          // { name: "Magnetic" },
          // { name: "Zeros", value: 37 }
          // ];
          status.sort(function(a, b){

          if(a.value > b.value){
            return -1;
          }
          else if(a.value < b.value){
            return 1;
          } 
          return 0;
          });

          return status;
        }

        function removeAllChildInDiv(div) {
          while(div.hasChildNodes() ){
            div.removeChild(div.lastChild);
          }
        }

        function getMovieAvatar() {
          var emotion_sub_div = document.createElement('div');
          emotion_sub_div.className = "poster_avatar_sub_div";
          return emotion_sub_div;
        }

        function getMovieAvatarDiv(data) {
          var avatar_div = document.createElement('div');
          var avatar_list = getAvatarDict(data);
          for (var j = 0; j<3; j++) {
            var avatar_at_index = avatar_list[j];
            var image_path = avatar_at_index.name;
            var count = avatar_at_index.value;
            var avatar_sub_div = getMovieAvatar();
            var avatar_image = document.createElement('img');
            avatar_image.className = 'poster_avatar_image';
            avatar_image.src = image_path;
            var avatar_count = document.createElement('div');
            avatar_count.className = 'poster_avatar_count'
            var num = summaryNumber(count);
            avatar_count.innerHTML = num;
            avatar_sub_div.appendChild(avatar_image);
            avatar_sub_div.appendChild(avatar_count);
            avatar_div.appendChild(avatar_sub_div);
          }
          return avatar_div;
        }

        function updateMovieDataInDiv(data, str_div) {
          // 'nowshowing_wraper', 'comingsoon_wraper'
          var comingsoon_wraper_div = document.getElementById(str_div);
          removeAllChildInDiv(comingsoon_wraper_div);
          var movie_list = data['movie_list'];
          for (var i = 0; i < movie_list.length; i++) {
            var movie_id = movie_list[i]['movie_id'];
            var name_en = movie_list[i]['name_en'];
            var name_th = movie_list[i]['name_th'];
            var link = document.createElement('a');
            // link.href = '/detail?movie_id='+movie_id;
            link.href = '/detail/'+movie_id;
            var wrapper_div = document.createElement('div');
            var poster_div_id = 'poster_div';
            if (i > 4) 
              poster_div_id = 'poster_div_with_top_margin';
            wrapper_div.className = poster_div_id;
            link.appendChild(wrapper_div);
            var image_div = document.createElement('div');
            var image = document.createElement('img')
            image.src = '/image?movie_id='+movie_id;
            image.className = 'poster_image';
            image_div.appendChild(image);
            var title_div = document.createElement('div');

            var poster_title = 'poster_title';
            if (str_div == 'comingsoon_wraper')
              poster_title = 'comingsoon_poster_title';
            title_div.className = poster_title;

            var title_link = document.createElement('a');
            title_link.id = 'nowshowing_poster_link';
            // title_link.href = '/detail?movie_id='+movie_id;
            title_link.href = '/detail/'+movie_id;
            title_link.innerHTML = name_en;
            title_div.appendChild(title_link);
            wrapper_div.appendChild(image_div);

            if (str_div == 'nowshowing_wraper') {
              var avatar_div = getMovieAvatarDiv(movie_list[i]);
              wrapper_div.appendChild(avatar_div);  
            }
            
            wrapper_div.appendChild(title_div);
            comingsoon_wraper_div.appendChild(link);
          }
          if (str_div == 'nowshowing_wraper') 
            nowShowingFadeIn();
          else if (str_div == 'comingsoon_wraper')
            comingSoonFadeIn();
        }

        function updateNowShowingListView(json) {
          var div = document.getElementById('nowshowing_wraper');
          var movie_list = json['movie_list'];
          for (var i = 0; i < movie_list.length; i++) {
            var movie_data = movie_list[i];
            var user_id = 0;
            {% if userData %}
              user_id = {{userData.user_id}};
            {% endif %}
            div.appendChild(new MoviewListView($('#nowshowing_wraper'), movie_data, user_id));
          }
        }


        function getNowShowing(page_count) {
          // nowShowingFadeOut();
          current_page = page_count;
          // updatePositionNowShowingcarousel();
          var formData = new FormData();
          formData.append('page', page_count);
          formData.append('data_per_page', {{nowshowing_per_page}})
          // formData.append('_ajax_nonce', importNonce);
          $.ajax({
            url: '/api_get_nowshowing',  //Server script to process data
            type: 'POST',
            mimeType:"multipart/form-data",
            dataType: 'json',
            success: function(json) {
              updateNowShowingListView(json);
              //updateMovieDataInDiv(json, 'nowshowing_wraper');
            },
            data: formData,
            cache: false,
            contentType: false,
            processData: false
          });
        }

        function getComingSoon(page_count) {
          comingSoonFadeOut();
          comingsoon_current_page = page_count;
          updatePositionComingSooncarousel();
          var formData = new FormData();
          formData.append('page', page_count);
          $.ajax({
            url: '/api_get_comingsoon',  //Server script to process data
            type: 'POST',
            mimeType:"multipart/form-data",
            dataType: 'json',
            success: function(json) {
              updateMovieDataInDiv(json, 'comingsoon_wraper');
            },
            data: formData,
            cache: false,
            contentType: false,
            processData: false
          });
        }

        function getNowShowingcarousel(index) {
          var searchEles = document.getElementById("page_btn_div").children;
          var btnDiv = searchEles[index];
          var carousel = btnDiv.children[0];
          return carousel;
        }

        function getComingSooncarousel(index) {
          var searchEles = document.getElementById("comingsoon_page_btn_div").children;
          var btnDiv = searchEles[index];
          var carousel = btnDiv.children[0];
          return carousel;
        }

        function removeAllNowShowingcarouselHiligh() {
          var searchEles = document.getElementById("page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getNowShowingcarousel(i);
            carousel.className = "";
            carousel.className = "btn_carousel";
          }
        }

        function removeAllComingSooncarouselHiligh() {
          var searchEles = document.getElementById("comingsoon_page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getComingSooncarousel(i);
            carousel.className = "";
            carousel.className = "btn_carousel";
          }
        }

        function disableCarousel(carousel_id) {
          var carousel = document.getElementById(carousel_id);
          carousel.className = 'btn_carousel_disable';
          carousel.removeAttribute("href")
        }

        function enableCarousel(carousel_id) {
          var carousel = document.getElementById(carousel_id);
          carousel.className = 'btn_carousel';
        }

        function enableAllNowShowingCarousel() {
          $("#prev_page_link").attr("href", "javascript:getNowShowing("+ (current_page - 1) +");");
          $("#next_page_link").attr("href", "javascript:getNowShowing("+ (current_page + 1) +");");
          $("#last_page_link").attr("href", "javascript:getNowShowing("+ all_nowshowing_page +");");
          $("#first_page_link").attr("href", "javascript:getNowShowing(1);");
          enableCarousel('prev_page_link');
          enableCarousel('next_page_link');
          enableCarousel('last_page_link');
          enableCarousel('first_page_link');
        }

        function updatePositionNowShowingcarousel() {
          enableAllNowShowingCarousel();
          if (current_page <= 1) {
            disableCarousel('prev_page_link');
            disableCarousel('first_page_link');
          }
            
          if (current_page == all_nowshowing_page) {
              disableCarousel('next_page_link');
              disableCarousel('last_page_link');            
          }

          var allPageLink = document.getElementById('all_page_link');
          allPageLink.innerHTML = 'Page '+ current_page + ' of ' +  all_nowshowing_page;
          removeAllNowShowingcarouselHiligh();
          if (btn_nowshowing_count >= 5) {
            var current_margin = all_nowshowing_page - current_page;
            if (current_margin < 4) {
              var startPage = all_nowshowing_page - 4;
              renewNowShowingcarousel(startPage);
            } else {
              renewNowShowingcarousel(current_page);
            }
          } 

          var searchEles = document.getElementById("page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getNowShowingcarousel(i);
            var a = parseInt(carousel.innerHTML);
            if (a == current_page) {
              carousel.className = "";
              carousel.className = "btn_carousel_select";
            }
          }
        }

        function enableAllComingSoonCarousel() {
          $("#comingsoon_prev_page_link").attr("href", "javascript:getComingSoon("+ (comingsoon_current_page - 1) +");");
          $("#comingsoon_next_page_link").attr("href", "javascript:getComingSoon("+ (comingsoon_current_page + 1) +");");
          $("#comingsoon_last_page_link").attr("href", "javascript:getComingSoon("+ all_comingsoon_page +");");
          $("#comingsoon_first_page_link").attr("href", "javascript:getComingSoon(1);");
          enableCarousel('comingsoon_prev_page_link');
          enableCarousel('comingsoon_next_page_link');
          enableCarousel('comingsoon_last_page_link');
          enableCarousel('comingsoon_first_page_link');
        }

        function updatePositionComingSooncarousel() {
          enableAllComingSoonCarousel();
          if (comingsoon_current_page <= 1) {
            disableCarousel('comingsoon_prev_page_link');
            disableCarousel('comingsoon_first_page_link');
          }
            
          if (comingsoon_current_page == all_comingsoon_page) {
            disableCarousel('comingsoon_next_page_link');
            disableCarousel('comingsoon_last_page_link');
          } 

          var allPageLink = document.getElementById('comingsoon_all_page_link');
          allPageLink.innerHTML = 'Page '+ comingsoon_current_page + ' of ' +  all_comingsoon_page;
          removeAllComingSooncarouselHiligh();
          if (btn_comingsoon_count >= 5) {
            var current_margin = all_comingsoon_page - comingsoon_current_page;
            if (current_margin < 4) {
              var startPage = all_comingsoon_page - 4;
              renewComingSooncarousel(startPage);
            } else {
              renewComingSooncarousel(comingsoon_current_page);
            }
          } 

          var searchEles = document.getElementById("comingsoon_page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getComingSooncarousel(i);
            var a = parseInt(carousel.innerHTML);
            if (a == comingsoon_current_page) {
              carousel.className = "";
              carousel.className = "btn_carousel_select";
            }
          }
        }

        function renewNowShowingcarousel(first_index) {
          var searchEles = document.getElementById("page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getNowShowingcarousel(i);
            var index = (first_index+i);
            carousel.innerHTML = ""+ index;
            carousel.href = "javascript:getNowShowing("+ index +");";
          }
        }

        function renewComingSooncarousel(first_index) {
          var searchEles = document.getElementById("comingsoon_page_btn_div").children;
          for(var i = 0; i < searchEles.length; i++) {
            var carousel = getComingSooncarousel(i);
            var index = (first_index+i);
            carousel.innerHTML = ""+ index;
            carousel.href = "javascript:getComingSoon("+ index +");";
          }
        }

        function initPaginationButton() {
          all_nowshowing_count = {{record_object.nowshowing_count}};
          all_nowshowing_page = all_nowshowing_count / {{nowshowing_per_page}};
          all_nowshowing_page = Math.ceil(all_nowshowing_page);
          btn_nowshowing_count = 5;
          if (all_nowshowing_page < 5)
            btn_nowshowing_count = all_nowshowing_page;
          var btnParentDiv = document.getElementById('page_btn_div');
          var allPageLink = document.getElementById('all_page_link');
          allPageLink.innerHTML = 'Page '+ current_page + ' of ' +  all_nowshowing_page;
          for (var i = 0; i < btn_nowshowing_count; i++) {
            var btnWrapperDiv = document.createElement('div');
            btnWrapperDiv.className = 'btn_carousel_div';
            var btnDiv = document.createElement('a');
            var pageIndex = (current_page + i);
            btnDiv.innerHTML = ''+ pageIndex;
            btnDiv.href = "javascript:getNowShowing("+ pageIndex +");";
            btnWrapperDiv.appendChild(btnDiv);
            btnParentDiv.appendChild(btnWrapperDiv);
          }

        }

        function initComingsoonPaginationButton() {
          all_comingsoon_count = {{record_object.comingsoon_count}};
          all_comingsoon_page = all_comingsoon_count / {{comingsoon_per_page}};
          all_comingsoon_page = Math.ceil(all_comingsoon_page);
          btn_comingsoon_count = 5;
          if (all_comingsoon_page < 5)
            btn_comingsoon_count = all_comingsoon_page;

          var btnParentDiv = document.getElementById('comingsoon_page_btn_div');
          var allPageLink = document.getElementById('comingsoon_all_page_link');
          allPageLink.innerHTML = 'Page '+ comingsoon_current_page + ' of ' +  all_comingsoon_page;
          for (var i = 0; i < btn_comingsoon_count; i++) {
            var btnWrapperDiv = document.createElement('div');
            btnWrapperDiv.className = 'btn_carousel_div';
            var btnDiv = document.createElement('a');
            var pageIndex = (comingsoon_current_page + i);
            btnDiv.innerHTML = ''+ pageIndex;
            btnDiv.href = "javascript:getComingSoon("+ pageIndex +");";
            btnWrapperDiv.appendChild(btnDiv);
            btnParentDiv.appendChild(btnWrapperDiv);
          }
        }

        function checkScrollTo() {
          setTimeout(function() {
            scrollToDiv('{{scroll_to}}');
          }, 200);
        }

        $(document).ready(function() {
          $('#nav_home').addClass('active');
          // initPaginationButton();
          // randomMovie();
          // initComingsoonPaginationButton();
          getNowShowing(current_page);
          // getComingSoon(comingsoon_current_page);
          {% if scroll_to %}
            checkScrollTo();
          {% endif %}

        });



          // var count = 0;
          // var sliderWidth = 816 + 39;
          // var slider = $('#slider');
          // var sliderCount = $('div', slider).length;
          // slider.width(sliderCount * sliderWidth);

          // $('#date-nav-prev').click(function () { 
          //     if (count == 0)
          //       return;
          //     $('#slider').animate({left: '+='+sliderWidth}, 500);
          //     count -=1;
          // });

          // $('#date-nav-next').click(function () {
          //     if (count == 3)
          //       return;
          //     $('#slider').animate({left: '-='+sliderWidth}, 500);
          //     count +=1;
          // });

      </script>
    </head>
    <body>
      {% include "/main_header.html" with context %}
      <div id="main_body_div">
        <!-- <div id="youtube_div"><iframe id="feature_youtube_frame" frameborder="0" allowfullscreen></iframe></div> -->
        <div id="nowshowing_div">
          <div id="nowshowing_caption" class="main_page_caption">NOW SHOWING</div>
          <div id="nowshowing_wraper_div">
            <div id="nowshowing_wraper">
            </div>
          </div>
          
          <!-- <div class="carousel_div">
            <div class="btn_carousel_div"><a class="btn_carousel" id="all_page_link"></a></div>
            <div class="btn_carousel_div"><a class="btn_carousel" id="first_page_link"><< First</a></div>
            <div class="btn_carousel_div"><a class="btn_carousel" id="prev_page_link">< Prev</a></div>
            <div id="page_btn_div"></div>
            <div class="btn_carousel_div"><a class="btn_carousel" id="next_page_link">Next ></a></div>
            <div class="btn_carousel_div"><a class="btn_carousel" id="last_page_link">Last >></a></div>
          </div> -->
        </div>
        <!-- <div id="comingsoon_div">
          <div id="inner_comingsoon_div" class="round-corner">
            <div id="comingsoon_caption" class="main_page_caption">COMING SOON</div>
            <div id="comingsoon_wraper_div">
              <div id="comingsoon_wraper"></div>
            </div>
            <div class="carousel_div">
              <div class="btn_carousel_div"><a class="btn_carousel" id="comingsoon_all_page_link"></a></div>
              <div class="btn_carousel_div"><a class="btn_carousel" id="comingsoon_first_page_link"><< First</a></div>
              <div class="btn_carousel_div"><a class="btn_carousel" id="comingsoon_prev_page_link">< Prev</a></div>
              <div id="comingsoon_page_btn_div"></div>
              <div class="btn_carousel_div"><a class="btn_carousel" id="comingsoon_next_page_link">Next ></a></div>
              <div class="btn_carousel_div"><a class="btn_carousel" id="comingsoon_last_page_link">Last >></a></div> 
            </div>
            
          </div> -->
        </div>
        {% include "/main_footer.html" with context %}
      </div> 
  </body>
</html>
{% endautoescape %}

      <!-- <div id="nowshowing_wraper_and_button_parent">
            <div id="btn_prev_div">
              <input type="image" src="/images/mains/icon_previous.png" class="slide_button" id="date-nav-prev">
            </div>
            <div id="btn_next_div">
              <input type="image" src="/images/mains/icon_next.png" class="slide_button" id="date-nav-next">
            </div>
            <div id="nowshowing_wraper_parent">
              <div id="wrapper">
                <div id="slider">
                  {% for movie in movie_list %}
                    <a href="/detail?movie_id={{movie.id}}"> 
                      <div class="nowshowing_poster_div">
                        <div>
                          <img class="poster_image" border="0" src="/image?movie_id={{ movie.id }}">
                        </div>
                        <div class="poster_title"><a id="nowshowing_poster_link" href="/detail?movie_id={{movie.id}}">  {{movie.name_en}}<a/></div>
                      </div>
                    <a/>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div> -->

